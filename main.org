#+TITLE: Emacs configuration
#+STARTUP: indent
#+OPTIONS: H:5 num:nil tags:nil toc:nil timestamps:t
#+LAYOUT: post
#+DESCRIPTION: Loading emacs configuration using org-babel
#+TAGS: emacs
#+CATEGORIES: editing

* Introduction

Deffered compilation
https://masteringemacs.org/article/speed-up-emacs-libjansson-native-elisp-compilation

#+BEGIN_SRC emacs-lisp :results output silent
(setq comp-deferred-compilation t)
#+END_SRC

Set credentials
#+BEGIN_SRC emacs-lisp :results output silent
  (setq user-full-name "Alexander Kapustin")
  (setq user-mail-address "dyens@mail.ru")
#+END_SRC

Disable beep
#+BEGIN_SRC emacs-lisp :results output silent
(setq ring-bell-function 'ignore)
#+END_SRC

Be sure to just ask for y/n instead of yes/no.
#+BEGIN_SRC emacs-lisp :results output silent
  (fset 'yes-or-no-p 'y-or-n-p)
#+END_SRC

Disable startup secreen.
#+BEGIN_SRC emacs-lisp :results output silent
  (setq inhibit-startup-screen t)
#+END_SRC

Base settings
#+BEGIN_SRC emacs-lisp :results output silent
;; Scrolling
(setq mouse-wheel-scroll-amount '(1)    ; scroll gentle
      mouse-wheel-progressive-speed nil ; don't accelerate
      scroll-conservatively 101         ; don't jump to the middle of screen
      hscroll-margin 1                  ; don't you scroll that early!
      hscroll-step 1                    ; but scroll just a bit
      scroll-preserve-screen-position t) ; try to keep cursor in its position
#+END_SRC

Display line numbers
#+BEGIN_SRC emacs-lisp :results output silent
(customize-set-variable 'display-line-numbers-type 'visual)
(global-display-line-numbers-mode)
#+END_SRC

Search for non ascii characters
https://endlessparentheses.com/new-in-emacs-25-1-easily-search-non-ascii-characters.html
#+BEGIN_SRC emacs-lisp :results output silent
  (setq search-default-mode #'char-fold-to-regexp)
#+END_SRC

Warning level
#+BEGIN_SRC emacs-lisp :results output silent
(setq warning-minimum-level :emergency)
#+END_SRC
* Installing use-package
** Setup
#+BEGIN_SRC emacs-lisp :results output silent
  (require 'package)
  (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/"))
  (package-initialize)
#+END_SRC
For refresh packages run (M-x package-refresh-contents)

* Backup
This is one of the things people usually want to change right away. By
default, Emacs saves backup files in the current directory. These are
the files ending in ~ that are cluttering up your directory lists. The
following code stashes them all in ~/.emacs.d/backups, where I can
find them with C-x C-f (find-file) if I really need to.
#+BEGIN_SRC emacs-lisp :results output silent
  (setq backup-directory-alist '(("." . "~/.emacs.d/backups")))
#+END_SRC

Disk space is cheap. Save lots. 
#+BEGIN_SRC emacs-lisp :results output silent
  (setq delete-old-versions -1)
  (setq version-control t)
  (setq vc-make-backup-files t)
  (setq auto-save-file-name-transforms '((".*" "~/.emacs.d/auto-save-list/" t)))
#+END_SRC

* World time
#+BEGIN_SRC emacs-lisp :results output silent
(custom-set-variables
 '(zoneinfo-style-world-list
   '(("Etc/UTC" "ITC")
     ("Europe/Moscow" "Moscow")
     ("Asia/Irkutsk" "Irkutsk")
     ("America/New_York" "New York")
     )))
#+END_SRC

* History
This is one of the things people usually want to change right away. By
default, Emacs saves backup files in the current directory. These are
the files ending in ~ that are cluttering up your directory lists. The
following code stashes them all in ~/.emacs.d/backups, where I can
find them with C-x C-f (find-file) if I really need to.
#+BEGIN_SRC emacs-lisp :results output silent
(setq savehist-file "~/.emacs.d/savehist")
(savehist-mode 1)
(setq history-length t)
(setq history-delete-duplicates t)
(setq savehist-save-minibuffer-history 1)
(setq savehist-additional-variables
      '(kill-ring
        search-ring
        regexp-search-ring))
#+END_SRC

* GUI
** Disable bars
#+BEGIN_SRC emacs-lisp :results output silent
  (menu-bar-mode -1)
  (tool-bar-mode -1)
  (scroll-bar-mode -1)
  (display-time-mode -1)
#+END_SRC

** Fix gaps in DWM
#+BEGIN_SRC emacs-lisp :results output silent
  (setq frame-resize-pixelwise t)
#+END_SRC
** Column number mode
#+BEGIN_SRC emacs-lisp :results output silent
;(setq column-number-mode t) ;; show columns in addition to rows in mode line
#+END_SRC

** Paren mode
#+BEGIN_SRC emacs-lisp :results output silent
  (show-paren-mode)
#+END_SRC
** Theme
#+BEGIN_SRC emacs-lisp :results output silent

;;(use-package color-theme-sanityinc-tomorrow
;;  :ensure t
;;  :config
;;  (color-theme-sanityinc-tomorrow-night))

;; (use-package gruvbox-theme
;;   :ensure t
;;   :config
;;   (load-theme 'gruvbox t))
;; (load-theme 'wombat t)
;; (load-theme 'deeper-blue t)

;;  (use-package apropospriate-theme
;;    :ensure t
;;    :config 
;;    (load-theme 'apropospriate-dark t)
;;    ;; or
;;    ;; (load-theme 'apropospriate-light t)
;;  )

  ;;  (use-package modus-operandi-theme
  ;;    :ensure t)
  ;;
  ;; (use-package modus-vivendi-theme
  ;; :ensure t)
  ;;
  ;;  (load-theme 'modus-operandi t)           ; Light theme
   ;; (load-theme 'apropospriate-dark t)
   ;; (global-hl-line-mode t)



;;(use-package kaolin-themes
;;  :ensure t
;;  :config 
;;  (load-theme 'kaolin-light t))

;; BEST!!!!
;; (load-theme 'dichromacy t)

;; (use-package ef-themes
;;   :ensure t
;;   :config
;;   (load-theme 'ef-day t)
;; )

;; (use-package gruvbox-theme
;;   :ensure t
;;   :config
;;   (load-theme 'gruvbox-light-medium t)
;; )

(defun dy-modus-theme () 
  (setq modus-themes-italic-constructs t
      modus-themes-region '(bg-only)
      modus-themes-bold-constructs t
      modus-themes-syntax '( faint yellow-comments green-strings alt-syntax)
      modus-themes-paren-match '(bold intense underline)
      modus-themes-mode-line '(accented borderless)
      )
  ;; dark theme
   (load-theme 'modus-vivendi t)
   )
;; (dy-modus-theme)


  ;; My default theme
(defun dy-light-theme ()
    (scroll-bar-mode 0)
    (fringe-mode 0)

    (set-face-attribute 'mode-line nil :box nil)
    (set-face-attribute 'mode-line-inactive nil :box nil)

    (set-face-attribute 'mode-line nil :background "#c6edf9")
    (set-face-attribute 'mode-line-inactive nil :background "#FAFAFA")

    (set-face-background 'vertical-border "gray")
    (set-face-foreground 'vertical-border (face-background 'vertical-border)))

 ;; (dy-light-theme)


     (load-theme 'ef-deuteranopia-dark t)
    ; (load-theme 'ef-cyprus t)

    ; (load-theme 'adwaita t)
    ; (load-theme 'gruvbox-dark-hard t)
    ;; (load-theme 'gruber-darker t)

    ; (load-theme 'dracula t)

    ; (require 'doom-themes)

    ;; Global settings (defaults)
    ; (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
    ;     doom-themes-enable-italic t) ; if nil, italics is universally disabled

    ;; Load the theme (doom-one, doom-molokai, etc); keep in mind that each theme
    ;; may have their own settings.
    ; (load-theme 'whiteboard t)

    ;; Enable flashing mode-line on errors
    ; (doom-themes-visual-bell-config)

    ;; Enable custom neotree theme (all-the-icons must be installed!)
    ; (doom-themes-neotree-config)
    ;; or for treemacs users
    ; (setq doom-themes-treemacs-theme "doom-colors") ; use the colorful treemacs theme
    ; (doom-themes-treemacs-config)

;; Corrects (and improves) org-mode's native fontification.
    ; (doom-themes-org-config)
#+END_SRC

** Pretty symbols
#+BEGIN_SRC emacs-lisp :results output silent
  (global-prettify-symbols-mode 1)
#+END_SRC

** Font
#+BEGIN_SRC emacs-lisp :results output silent
(set-face-attribute 'default nil
                    :family "Iosevka SS04"
                    :height 110
                    :weight 'medium
                    :width 'normal
)
#+END_SRC
** Winner mode
#+BEGIN_SRC emacs-lisp :results output silent
;; C-c left - undo
;; C-c rignt - redo
(winner-mode t)
#+END_SRC

* String-inflection
#+BEGIN_SRC emacs-lisp :results output silent
(use-package string-inflection
  :ensure t
)
#+END_SRC

* Perspective
#+BEGIN_SRC emacs-lisp :results output silent
(use-package perspective
  :ensure t
  :config
  (setq persp-suppress-no-prefix-key-warning t)
  (persp-mode)
)
(use-package persp-projectile
  :ensure t
  :config
  (keymap-set projectile-mode-map "s-s" 'projectile-persp-switch-project)
)
#+END_SRC

* Evil mode
#+BEGIN_SRC emacs-lisp :results output silent

(setq evil-want-C-i-jump nil)
;; for work with abc_abc words
(with-eval-after-load 'evil
    (defalias #'forward-evil-word #'forward-evil-symbol)
    ;; make evil-search-word look for symbol rather than word boundaries
    (setq-default evil-symbol-word-search t))

(use-package evil
  :ensure t
  :init
  (setq evil-want-integration t) ;; This is optional since it's already set to t by default.
  (setq evil-want-keybinding nil)
  ;; Put a cursor to a new window
  (setq evil-vsplit-window-right t)
  (setq evil-split-window-below t)
  ;; Fix org tab key
  (setq evil-want-C-i-jump nil)
  :config 
  (evil-mode 1)
  ;; With new evil changes and new emacs evil use different undo systemes
  (evil-set-undo-system 'undo-redo)
  (keymap-set evil-normal-state-map "<f5>" #'modus-themes-toggle)

  ;; C-o defined for jump back
  ;; C-i for jump forward
  (keymap-set evil-normal-state-map "C-i" 'evil-jump-forward)

  (keymap-set evil-normal-state-map "<SPC> f" 'find-file)
  (keymap-set evil-normal-state-map "<SPC> b" 'switch-to-buffer)
  (keymap-set evil-normal-state-map "<SPC> i" 'consult-imenu)
  (keymap-set evil-normal-state-map "<SPC> I" 'consult-imenu-multi)
  (keymap-set evil-normal-state-map "<SPC> s" 'consult-ripgrep)

  (keymap-set evil-normal-state-map "<SPC> w" 'ace-window)

  (keymap-set evil-normal-state-map "<SPC> g" 'magit-status)
  (keymap-set evil-normal-state-map "<SPC> a a" 'org-agenda)
  (keymap-set evil-normal-state-map "<SPC> a c" 'org-capture)

  (keymap-set evil-normal-state-map "<SPC> c" 'compile)

  (keymap-set evil-normal-state-map "<SPC> #" 'comment-line)
  (keymap-set evil-visual-state-map "<SPC> #" 'comment-line)

  (keymap-set evil-normal-state-map "C-u" 'evil-scroll-up)
  (keymap-set evil-visual-state-map "C-u" 'evil-scroll-up)
  ;; Instead of C-u
  (keymap-set evil-normal-state-map "<SPC> u" 'universal-argument)
  (keymap-set evil-insert-state-map "C-l" 'yas-expand-from-trigger-key)

  (keymap-set evil-normal-state-map "<SPC> l" 'perspective-map)

  ;; Github jump
  (keymap-set evil-normal-state-map "<SPC> m b" 'dy-open-in-github-branch)
  (keymap-set evil-normal-state-map "<SPC> m B" 'dy-open-in-github-rev)

  (keymap-set evil-visual-state-map "<SPC> m b" 'dy-open-in-github-branch)
  (keymap-set evil-visual-state-map "<SPC> m B" 'dy-open-in-github-rev)

  ;; fast function
  (keymap-set evil-normal-state-map "<SPC> ~" 'dy-set-fast-function)
  (keymap-set evil-visual-state-map "<SPC> ~" 'dy-set-fast-function)

  (defun dy-function-not-found ()
    "Function is not find"
    (interactive)
  (error "Fast function is not defined: use dy-set-fast-function"))

  (keymap-set evil-normal-state-map "<SPC> `" 'dy-function-not-found)

  ;; (keymap-set evil-normal-state-map "<SPC> ." 'flymake-goto-next-error)
  ;; (keymap-set evil-normal-state-map "<SPC> >" 'flymake-goto-prev-error)

  (keymap-set evil-normal-state-map "<SPC> ." 'flycheck-next-error)
  (keymap-set evil-normal-state-map "<SPC> >" 'flycheck-previous-error)
  )

(use-package evil-collection
  :after evil
  :ensure t
  :config
  (evil-collection-init))

(use-package evil-string-inflection
  :after evil
  :ensure t
)

(use-package evil-escape
  :after evil
  :ensure t
  :config
  (setq-default evil-escape-key-sequence "fd")
  (evil-escape-mode 1))

#+END_SRC

* Vertico
#+BEGIN_SRC emacs-lisp :results output silent
(use-package vertico
:ensure t
:init
(vertico-mode))
#+END_SRC
* Orderless
#+BEGIN_SRC emacs-lisp :results output silent
(use-package orderless
  :ensure t
  :init
  ;; Configure a custom style dispatcher (see the Consult wiki)
  ;; (setq orderless-style-dispatchers '(+orderless-dispatch)
  ;;       orderless-component-separator #'orderless-escapable-split-on-space)
  (setq completion-styles '(orderless)
        completion-category-defaults nil
        completion-category-overrides '((file (styles partial-completion emacs22 basic)))))
#+END_SRC
* Savehist
#+BEGIN_SRC emacs-lisp :results output silent
(use-package savehist
  :init
  (savehist-mode))

;; A few more useful configurations...
(use-package emacs
  :init
  ;; Add prompt indicator to `completing-read-multiple'.
  ;; Alternatively try `consult-completing-read-multiple'.
  (defun crm-indicator (args)
    (cons (concat "[CRM] " (car args)) (cdr args)))
  (advice-add #'completing-read-multiple :filter-args #'crm-indicator)

  ;; Do not allow the cursor in the minibuffer prompt
  (setq minibuffer-prompt-properties
        '(read-only t cursor-intangible t face minibuffer-prompt))
  (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)

  ;; Emacs 28: Hide commands in M-x which do not work in the current mode.
  ;; Vertico commands are hidden in normal buffers.
  ;; (setq read-extended-command-predicate
  ;;       #'command-completion-default-include-p)

  ;; Enable recursive minibuffers
  (setq enable-recursive-minibuffers t))
#+END_SRC
* Marginalia
#+BEGIN_SRC emacs-lisp :results output silent
(use-package marginalia
  :ensure t
  ;; Either bind `marginalia-cycle` globally or only in the minibuffer
  :bind (("M-A" . marginalia-cycle)
         :map minibuffer-local-map
         ("M-A" . marginalia-cycle))

  ;; The :init configuration is always executed (Not lazy!)
  :init

  ;; Must be in the :init section of use-package such that the mode gets
  ;; enabled right away. Note that this forces loading the package.
  (marginalia-mode))
#+END_SRC

* Consult
#+BEGIN_SRC emacs-lisp :results output silent
(use-package consult
:ensure t
:config
(setq consult-preview-key nil))
#+END_SRC

* Embark
#+BEGIN_SRC emacs-lisp :results output silent
(use-package embark
:ensure t
:bind
(("C-." . embark-act)
 ("C-h B" . embark-bindings)))

(use-package embark-consult
:after embark
:ensure t)
#+END_SRC
* Super-word-mode
For backward word and forwardword
#+BEGIN_SRC emacs-lisp :results output silent
  (superword-mode t)
#+END_SRC

* Magit
#+BEGIN_SRC emacs-lisp :results output silent
(use-package magit
  :ensure t
  :commands magit-status
  :config
  (setq magit-display-buffer-function 'magit-display-buffer-traditional)
  ;; (setq magit-display-buffer-function 'magit-display-buffer-fullframe-status-v1)
  (defun dy-git-commit-setup ()
    (let ((current-branch-name (upcase (magit-get-current-branch))))
      (if (string-match-p (regexp-quote "WEBDEV") current-branch-name)
	  (let ((issue-number (format "WEBDEV%s" (cadr (split-string current-branch-name "WEBDEV")))))
	    (insert (format " %s\n\nhttps://zyrl.atlassian.net/browse/%s" issue-number issue-number))
	    (goto-char 0)
	    (evil-insert 0)))

      (if (string-match-p (regexp-quote "VTBCLOUD") current-branch-name)
	  (when (string-match "\\(VTBCLOUD-\[0-9\]+\\)-\\(.*\\)" current-branch-name)
	    (let ((issue-number (match-string 1 current-branch-name))
		  (default-commit-message (dy-capitalize-first-char (replace-regexp-in-string "-" " " (downcase (match-string 2 current-branch-name))))))
	      (insert (format "%s: %s\n" issue-number default-commit-message))
	      (evil-previous-line 1)
	      (evil-end-of-line)
	      (evil-visual-state 1)
              (evil-backward-char (- (length default-commit-message) 1))

	      ))
	)

      (if (string-match-p (regexp-quote "A2205190") current-branch-name)
	  (when (string-match "\\(A2205190-\[0-9\]+\\)-\\(.*\\)" current-branch-name)
	    (let ((issue-number (match-string 1 current-branch-name))
		  (default-commit-message (dy-capitalize-first-char (replace-regexp-in-string "-" " " (downcase (match-string 2 current-branch-name))))))
	      (insert (format "%s: %s\n" issue-number default-commit-message))
	      (evil-previous-line 1)
	      (evil-end-of-line)
	      (evil-visual-state 1)
              (evil-backward-char (- (length default-commit-message) 1))

	      ))
	)
      ))

  (add-hook 'git-commit-setup-hook 'dy-git-commit-setup))
#+END_SRC

* Forge
#+BEGIN_SRC emacs-lisp :results output silent
;; (use-package forge
;;   :after magit
;;   :ensure t
;;   :config
;;   ;; Add qs github acc
;;   (push 
;;     '("github.com-qs"
;;     "api.github.com"
;;     "github.com"
;;     forge-github-repository) forge-alist))
#+END_SRC

* Company-mode
#+BEGIN_SRC emacs-lisp :results output silent
;; (use-package company
;;   :ensure t
;;   :custom
;;   (company-begin-commands '(self-insert-command))
;;   (company-idle-delay 0.3)
;;   (company-minimum-prefix-length 1)
;;   (company-show-numbers nil)
;;   (company-tooltip-align-annotations 't)
;;   :config
;;   (add-hook 'after-init-hook 'global-company-mode)
;;   )
#+END_SRC

* Corfu (replace company mode)
#+BEGIN_SRC emacs-lisp :results output silent
(use-package corfu
  :ensure t
  ;; Optional customizations
  :custom
  ;; (corfu-cycle t)                ;; Enable cycling for `corfu-next/previous'
  (corfu-auto t)                 ;; Enable auto completion
  ;; (corfu-separator ?\s)          ;; Orderless field separator
  ;; (corfu-quit-at-boundary nil)   ;; Never quit at completion boundary
  ;; (corfu-quit-no-match nil)      ;; Never quit, even if there is no match
  ;; (corfu-preview-current nil)    ;; Disable current candidate preview
  ;; (corfu-preselect-first nil)    ;; Disable candidate preselection
  ;; (corfu-on-exact-match nil)     ;; Configure handling of exact matches
  ;; (corfu-echo-documentation nil) ;; Disable documentation in the echo area
  ;; (corfu-scroll-margin 5)        ;; Use scroll margin

  ;; Enable Corfu only for certain modes.
  ;; :hook ((prog-mode . corfu-mode)
  ;;        (shell-mode . corfu-mode)
  ;;        (eshell-mode . corfu-mode))

  ;; Recommended: Enable Corfu globally.
  ;; This is recommended since Dabbrev can be used globally (M-/).
  ;; See also `corfu-excluded-modes'.
  :init
  (global-corfu-mode))

(use-package emacs
  :init
  ;; TAB cycle if there are only few candidates
  (setq completion-cycle-threshold 3)

  ;; Emacs 28: Hide commands in M-x which do not apply to the current mode.
  ;; Corfu commands are hidden, since they are not supposed to be used via M-x.
  ;; (setq read-extended-command-predicate
  ;;       #'command-completion-default-include-p)

  ;; Enable indentation+completion using the TAB key.
  ;; `completion-at-point' is often bound to M-TAB.
  (setq tab-always-indent 'complete))

#+END_SRC

* Python
** PDB file view on debug in vterm
#+BEGIN_SRC emacs-lisp :results output silent
(defun dy-pdb-debug-shell-mode-hook ()
  (add-hook
   'comint-output-filter-functions
   'python-pdbtrack-comint-output-filter-function t))
(add-hook 'shell-mode-hook 'dy-pdb-debug-shell-mode-hook)
#+END_SRC
** Pyright
Pyright stop working in last version
TODO remove this in some future:
#+BEGIN_SRC emacs-lisp :results output silent
(setenv "PYRIGHT_PYTHON_FORCE_VERSION" "1.1.290")
#+END_SRC
** Yapfify
#+BEGIN_SRC emacs-lisp :results output silent
(use-package yapfify
  :ensure t
  :after python)
#+END_SRC
** Black
#+BEGIN_SRC emacs-lisp :results output silent
(use-package blacken
  :ensure t
  :after python)
#+END_SRC
** Python mode
#+BEGIN_SRC emacs-lisp :results output silent
(use-package python
  :mode ("\\.py\\'" . python-mode)
  :after (flycheck)
  :config

  (setq python-indent-def-block-scale 1)
  (add-hook 'python-mode-hook 'dy-python-setup)
  ; Based on
  ; https://stackoverflow.com/questions/31443527/how-can-i-make-flycheck-use-virtualenv.
  ; Depends on modifying Python's sys.path in .pylintrc as in
  ; https://stackoverflow.com/a/39207275/437583 for this to work.
  (defun set-flychecker-executables ()
    "Configure virtualenv for flake8 and lint."
    (when (executable-find "flake8")
    (flycheck-set-checker-executable (quote python-flake8)
                                  (executable-find "flake8")))
    (when (executable-find "mypy")
    (flycheck-set-checker-executable (quote python-mypy)
                                  (executable-find "mypy"))))

;; TODO: work on python-ruff (split errors and warnings?)
(flycheck-define-checker python-ruff
  "Ruff syntax and type checker."
  :command ("ruff"
            "check"
            "--quiet"
            source)
  :error-patterns
  ((warning line-start
            (file-name) ":" line ":" (optional column ":") " "
            (id (one-or-more (any alpha)) (one-or-more digit)) " "
            (message (one-or-more not-newline))
            line-end))
  :working-directory flycheck-python-find-project-root
  :modes python-mode)
(setq flycheck-checkers (append flycheck-checkers  '(python-ruff)))



  (defun dy-python-setup ()
    ; Check with flake8, pylint, and mypy. python-mypy already runs
    ; python-flake8, so there's no need to mention it here. However, we still
    ; need to mention python-pylint to run after python-flake8. This is a
    ; so-called "checker chain", as per
    ; https://www.flycheck.org/en/latest/user/syntax-checkers.html#configuring-checker-chains.
    (flycheck-add-next-checker 'python-flake8 'python-pylint)
    (flycheck-add-next-checker 'python-pylint 'python-ruff)
    (add-hook 'flycheck-before-syntax-check-hook #'set-flychecker-executables
      'local)
    ; Start Flycheck.
    (flycheck-mode)
    ; Set max line length to 79 characters (from PEP8). (Although Emacs columns
    ; are 0-indexed, column-enforce-mode counts from 1, so we use 79 here and
    ; not 78.)
    (setq column-enforce-column 79)
    ; We need to tell Emacs to do paragrah-filling at 79 caharacters
    ; (column-enforce-mode only highlights regions --- it does not change how
    ; paragraph filling is done).
    (setq fill-column 79)
    ; (add-hook 'completion-at-point-functions
    ;           #'lsp-completion-at-point
    ;           'append)
))

#+END_SRC
** Virtualenv
#+BEGIN_SRC emacs-lisp :results output silent
  (use-package pyvenv
    :ensure t
    :config
    (defun pipenvenv-old ()
      (interactive)
      (setenv "WORKON_HOME" "/home/dyens/.virtualenvs")
        )

    (defun pipenvenv ()
      (interactive)
      (setenv "WORKON_HOME" "/home/dyens/.local/share/virtualenvs")
        )
    (defun poetryenv ()
      (interactive)
      (setenv "WORKON_HOME" "/home/dyens/.cache/pypoetry/virtualenvs/")
      )
    ;; default env
    (poetryenv)
    )
#+END_SRC

** Flycheck
#+BEGIN_SRC emacs-lisp :results output silent
  (use-package flycheck
    :ensure t
    )
#+END_SRC

** Py-isrot
#+BEGIN_SRC emacs-lisp :results output silent
(use-package py-isort
  :ensure t
  )
#+END_SRC
** Remove font lock from python shell
#+BEGIN_SRC emacs-lisp :results output silent
(setq python-shell-enable-font-lock nil)
#+END_SRC
** Pytest
#+BEGIN_SRC emacs-lisp :results output silent
  (use-package pytest
    :ensure t
    :config
    (custom-set-variables '(pytest-project-root-files '(".projectile" "setup.py" ".hg" ".git")))
    )
#+END_SRC
** Pyenv mode 
#+BEGIN_SRC emacs-lisp :results output silent
  (use-package pyenv-mode
    :ensure t
    :config
    )
#+END_SRC
** DyPython
#+BEGIN_SRC emacs-lisp :results output silent
(require 'flycheck)

;; TODO if noqa exist - extend it
(defun dy-python-add-noqa()
  "Add noqa for error string"
  (interactive)
  (save-excursion
    (let* ((errors (flycheck-overlay-errors-at (point)))
           (error-codes (seq-uniq (seq-map 'flycheck-error-id errors)))
           (error-string (mapconcat 'identity error-codes ","))
           (noqa-mes (format "  # NOQA:%s" error-string)))
      (move-end-of-line nil)
      (insert noqa-mes)
      )))

(defun dy-python-add-type-ignore()
  "Add mypy ingore" 
  (interactive)
  (save-excursion
    (move-end-of-line nil)
    (insert "  # type: ignore")
    ))

(require 'projectile)
(defun dy-update-tags()
  "Update etags"
  (interactive)
  (let* (
	 (etag-cmd   "etags --append --regex=\"/^\[\\t\]*async\[ \\t\]+def\[ \\t\\n\]+\[^ \\t\\n(:\]+/\"")
	 (cmds `(
		 "rm -f TAGS"
		 ,(format "find %s -type f -name '*.py' -print0 | xargs -0 %s" (eval dy-pyvenv-packages) etag-cmd)
		 ,(format "find %s -type f -name '*.py' -print0 | xargs -0 %s" (eval dy-pyenv-packages) etag-cmd)
		 ,(format "find . -type f -name '*.py' -print0 | xargs -0 %s" etag-cmd)))
	 (cmd (mapconcat 'identity cmds " && ")))
;; For suppress shell cmd output
(with-temp-buffer
  (projectile-with-default-dir (projectile-acquire-root)
    (shell-command cmd t "*Update tags errors*")))))
#+END_SRC

#+BEGIN_SRC emacs-lisp :results output silent
  (require 'python)
  ; for using string-trim
  (require 'subr-x)

  (defun dy-python-arg-params(arg-string)
    "Get python argument params from argument string (name, type, default)."
    (let* (
           (arg-value (split-string arg-string "[[:blank:]]*=[[:blank:]]*" t))
           (name-type-string (car arg-value))
           (name-type (split-string name-type-string "[[:blank:]]*:[[:blank:]]*" t))
           (name (car name-type))
           (type (nth 1 name-type))
           (default-value (nth 1 arg-value))
           )
      (list name type default-value)))

  (defun dy-python-split-args (arg-string)
    "Split a python argument string into ((name, type, default)..) tuples"
    (let* (
           (args (split-string arg-string "[[:blank:]]*,[[:blank:]]*" t))
           (args (seq-filter (lambda (x) (not (string-blank-p x))) args))
           (args (mapcar 'string-trim args))
           (arg-values (mapcar 'dy-python-arg-params args))
           )
      arg-values))


  (defun dy-python-args-to-docstring (args-string identation)
    "return docstring format for the python arguments in yas-text"
    (let* (
           (args (dy-python-split-args args-string))
           (args (if (string= (nth 0 (car args)) "self")
                     (cdr args)
                   args))
           (ident (make-string identation ?\s))
           (format-arg (lambda (arg)
                         (concat
                          ident
                          ":param "
                          (nth 0 arg)
                          ": " (nth 0 arg)
                          (if (nth 2 arg) (concat ", default=" (nth 2 arg)))
                          (if (nth 1 arg) (concat
                                       "\n"
                                       ident
                                       ":type "
                                       (nth 0 arg)
                                       ": "
                                       (nth 1 arg)
                                       ))
                          )
                         )
                       )
           (formatted-params (mapconcat format-arg args "\n")))
      (unless (string= formatted-params "")
        (mapconcat 'identity
                   (list  formatted-params)
                   "\n"))))



  (defun dy-python-return-to-docstring (return-string identation)
    "return docstring format for the python return type"
    (let* (
           (return-type (car (split-string return-string "[[:blank:]]*->[[:blank:]]*" t)))
           (ident (make-string identation ?\s))
           (formated-return (format "%s:rtype: %s" ident return-type)))
      (unless (string= return-type "nil") formated-return)))


  (add-hook 'dy-python-mode-hook
            (lambda () (set (make-local-variable 'yas-indent-line) 'fixed)))


(defun dy--python-add-docstring-to-function ($fname $fargs-string $docstring-shift)
  "Add docstring to function."
  (let ($fargs $docstring $docstring-header $docstring-args)
    (setq $docstring-header
	  (dy-capitalize-first-char (replace-regexp-in-string (regexp-quote "_") " " $fname)))

    (setq $fargs (dy-python-split-args $fargs-string))
    (search-forward  ":")
    (insert "\n")
    (insert $docstring-shift)
    (setq $docstring-header (format "\"\"\"%s." $docstring-header))
    (insert $docstring-header)
    (setq $fargs
	  (seq-filter (lambda (arg)
			 (let ((var-name (car arg)))
			       (and
				(not (string= "self" var-name))
				(not (string= "*" var-name))
				)))
		      $fargs))
    (message "%s" $fargs)
    (setq $docstring-args
      (mapcar
       (lambda (arg)
         (format ":param %s: %s"
    	     (car arg)
    	     (replace-regexp-in-string (regexp-quote "_") " " (car arg))))
       $fargs))
    (when $docstring-args
      (insert "\n")
      (dolist (arg $docstring-args)
    (insert "\n")
    (insert $docstring-shift)
    (insert arg))
      (insert "\n")
      (insert $docstring-shift)
      )
    (insert "\"\"\"")
  ))


(defun dy--python-add-docstring-to-class ($classname $docstring-shift)
  "Add docstring to class."
  (let ($classdocstring (case-fold-search nil))
    (message "%s" $classname)
    (setq $classdocstring (replace-regexp-in-string "\\([A-Z]\\)" " \\1" $classname))
    (setq $classdocstring (string-trim $classdocstring))
    (setq $classdocstring (downcase $classdocstring))
    (setq $classdocstring (dy-capitalize-first-char $classdocstring))
    (search-forward  ":")
    (insert "\n")
    (insert $docstring-shift)
    (insert "\"\"\"")
    (insert $classdocstring)
    (insert ".\"\"\"")
    ))

(defun dy-python-create-docstring ()
  "return docstring format for the python return type"
  (interactive)
    (python-nav-beginning-of-defun 1)
    ; jump to first now-whitespace symbol
    (back-to-indentation)
    (let* (
	  ($block-type (thing-at-point 'word))
	  ($block-start (current-column))
	  ($docstring-shift (make-string (+ 4 $block-start) 32))
	  )
      (cond
       ((string= $block-type "class")
	(let ($classname)
	  (re-search-forward
	   "[ \t]*class[ \t]*\\([a-zA-Z0-9_]+\\)" nil t)
	    (setq $classname (buffer-substring-no-properties (match-beginning 1) (match-end 1)))
	    (dy--python-add-docstring-to-class $classname $docstring-shift)
	))
       ((string= $block-type "async")
	(let ($fname $fargs-string $fargs $docstring $docstring-header $docstring-args)
	  (re-search-forward
	   "[ \t]*async[ \t]*def[ \t]*\\([a-zA-Z0-9_]+\\)[ \t]*\(\\([a-zA-Z0-9_\, \t\:=\n\*]*\\)\)" nil t)
	    (setq $fname (buffer-substring-no-properties (match-beginning 1) (match-end 1)))
	    (setq $fargs-string (buffer-substring-no-properties (match-beginning 2) (match-end 2)))
	    (dy--python-add-docstring-to-function $fname $fargs-string $docstring-shift)))
       ((string= $block-type "def")
	(let ($fname $fargs-string $fargs $docstring $docstring-header $docstring-args)
	  (re-search-forward
	   "[ \t]*def[ \t]*\\([a-zA-Z0-9_]+\\)[ \t]*\(\\([a-zA-Z0-9_\, \t\:=\n\*]*\\)\)" nil t)
	    (setq $fname (buffer-substring-no-properties (match-beginning 1) (match-end 1)))
	    (setq $fargs-string (buffer-substring-no-properties (match-beginning 2) (match-end 2)))
	    (dy--python-add-docstring-to-function $fname $fargs-string $docstring-shift))))))

  (defun dy-python-kwargs-to-dict ($start $end)
    "Convert kwargs arguments to dict.
     a=1, b=2 -> 'a': 1, 'b': 2
    "
    (interactive "r")
    (save-restriction
         (narrow-to-region $start $end)
         (goto-char (point-min))
         (replace-regexp "\\([_0-9a-zA-Z]+\\)\s*=\s*" "'\\1': ")
         ))

  (defun dy-python-dict-to-kwargs ($start $end)
    "Convert dict arguments to kwargs.
     'a': 1, 'b': 2 -> a=1, b=2
    "
    (interactive "r")
    (save-restriction
         (narrow-to-region $start $end)
         (goto-char (point-min))
         (replace-regexp "'\\([_0-9a-zA-Z]+\\)'\s*:\s*" "\\1=")
         ))


  (defun dy-python-dict-kwargs-toogle ($start $end)
    "Convert toogle dict kwargs args."
    (interactive "r")
    (if (seq-contains (buffer-substring $start $end) ?=)
        (dy-python-kwargs-to-dict $start $end)
      (dy-python-dict-to-kwargs $start $end)))

  (defun dy-py-split-string (&optional comma line-length)
    "Split string to multiple."
    (interactive)
    (unless comma (setq comma "'"))
    (unless line-length (setq line-length 70))
    (let (start (string-ended nil))
      (save-excursion
        (search-backward comma)
        (setq start (point))
        (insert "(\n")
        (indent-according-to-mode)
        (goto-char (+ 1(point)))
        (while (not string-ended)
  	(re-search-forward (format "[[:space:]%s]" comma))
  	(if (equal (buffer-substring-no-properties (match-beginning 0) (match-end 0)) " ")
  	    (if (>= (current-column) line-length)
  		(progn
  		(insert (format "%s\n%s" comma comma))
  		(indent-according-to-mode))
  	      )
  	  (setq string-ended 't)
  	  )
        )
        (insert "\n)")
        (indent-according-to-mode)
      )
    )
  )
 
#+END_SRC

#+BEGIN_SRC emacs-lisp :results output silent
(setq python-shell-interpreter "ipython")
(setq python-shell-interpreter-args "-i --simple-prompt")
#+END_SRC

#+BEGIN_SRC emacs-lisp :results output silent
;;  (use-package dap-mode
;;    :ensure t
;;  )
#+END_SRC

** Bidnings
#+BEGIN_SRC emacs-lisp :results output silent
(defcustom dy-pytest-arguments "--disable-warnings"
  "Pytest run arguments.")

(defun dy-pytest-one-without-warnings ()
  (interactive)
  (pytest-one  dy-pytest-arguments)
  )

;; (add-hook 'python-mode-hook 'eglot-ensure)

(add-hook
 'python-mode-hook
 (lambda()
   (keymap-set evil-normal-state-local-map "<SPC> t" 'dy-pytest-one-without-warnings)
   (keymap-set evil-normal-state-local-map "<SPC> T a" 'pytest-all)
   (keymap-set evil-normal-state-local-map "<SPC> T b" 'pytest-module)
   (keymap-set evil-normal-state-local-map "<SPC> T p" 'pytest-pdb-one)
   (keymap-set evil-normal-state-local-map "<SPC> i" 'py-isort-buffer)
   (keymap-set evil-normal-state-local-map "<SPC> m d" 'dy-python-create-docstring)
   (keymap-set evil-visual-state-local-map "<SPC> m a" 'dy-python-dict-kwargs-toogle)
   (keymap-set evil-normal-state-local-map "<SPC> m i" 'dy-python-add-noqa)
   (keymap-set evil-normal-state-local-map "<SPC> m t" 'dy-python-add-type-ignore)
   (keymap-set evil-normal-state-local-map "<SPC> m s" 'dy-py-split-string)
   (keymap-set evil-normal-state-local-map "<SPC> m f" 'flycheck-list-errors)
   ;; (keymap-set evil-normal-state-local-map "g d" 'lsp-find-definition)
   ;; (keymap-set evil-normal-state-local-map "<SPC> =" 'yapfify-region-or-buffer)
   (keymap-set evil-normal-state-local-map "<SPC> =" 'blacken-buffer)
   (keymap-set evil-normal-state-local-map "<SPC> m R" 'run-python)
   (keymap-set evil-visual-state-local-map "<SPC> m r" 'python-shell-send-region)
   (keymap-set evil-normal-state-local-map "<SPC> m b" 'python-shell-send-buffer)

   ;; (keymap-set evil-normal-state-local-map "<SPC> I" 'lsp-ui-imenu)
   ))
#+END_SRC

* GO
#+BEGIN_SRC emacs-lisp :results output silent
(use-package go-mode
  :ensure t
  :config
  (add-hook 'go-mode-hook 'eglot-ensure)
  )
#+END_SRC

* Ansi-color
#+BEGIN_SRC emacs-lisp :results output silent
  (use-package ansi-color
    :ensure t
    :config 
    (defun colorize-compilation-buffer ()
      (ansi-color-apply-on-region compilation-filter-start (point)))
    (add-hook 'compilation-filter-hook 'colorize-compilation-buffer)
    )
#+END_SRC

* Restclient
#+BEGIN_SRC emacs-lisp :results output silent
  (use-package restclient
    :ensure t
    :mode ("\\.http\\'" . restclient-mode)
    )
#+END_SRC

* Projectile
#+BEGIN_SRC emacs-lisp :results output silent
(use-package projectile
  :ensure t
  :config 
  (projectile-mode +1)
  (keymap-set evil-normal-state-map "<SPC> p" 'projectile-command-map)
  (setq projectile-use-git-grep t)
  (setq projectile-completion-system 'default)

  (keymap-set projectile-command-map "C" 'dy-compile-command-choice)

;; (defvar dy-compilation-commands '(
;; 	(?1 "ls" "ls" nil)
;;       )
;;   "List of compilation commands")
;; (put 'dy-compilation-commands 'safe-local-variable #'listp) 
;; 
;; (defun dy-compile-command-choice ()
;;   "Choice project compile command."
;;   (interactive)
;;   (let ((choice (read-char-choice (mapconcat (lambda (item) (format "%c: %s" (car item) (cadr item))) dy-compilation-commands "\n")
;;                   (mapcar #'car dy-compilation-commands))))
;;     (let (
;; 	  (command-map (if (projectile--cache-project-commands-p) projectile-compilation-cmd-map))
;; 	  (command (nth 2 (assoc choice dy-compilation-commands)))
;; 	  (is-interactive (nth 3 (assoc choice dy-compilation-commands)))
;; 	  )
;;       (when command-map
;;        (puthash default-directory command command-map)
;; 	)
;; 
;;       (save-some-buffers (not compilation-ask-about-save)
;;                          (lambda ()
;;                            (projectile-project-buffer-p (current-buffer)
;;                                                         (projectile-project-root))))
;; 
;;       (message command)
;;       (projectile-run-compilation command is-interactive)
;; 	  )
;;     ))


(defun dy-compile-command-choice ()
  "Choice project compile command."
  (interactive)

  (fset 'run-command-recipe-proj run-command-recipe-proj)
(setq run-command-recipes '(run-command-recipe-proj))
(run-command)

))

#+END_SRC
* Docker
#+BEGIN_SRC emacs-lisp :results output silent
  (use-package dockerfile-mode
    :ensure t
    :mode ("\\Dockerfile\\'" . dockerfile-mode)
  )
#+END_SRC

* Which-key
#+BEGIN_SRC emacs-lisp :results output silent
  (use-package which-key
    :ensure t
    :config
    (which-key-mode)
  )
#+END_SRC

* Docker-compose
#+BEGIN_SRC emacs-lisp :results output silent
  (use-package docker-compose-mode
    :ensure t
    :mode ("\\Dockerfile\\'" . dockerfile-mode)
  )
#+END_SRC

* Org
#+BEGIN_SRC emacs-lisp :results output silent
(use-package org
  :ensure t
  :custom
  (shell-file-name "bash" "default shell is bash")
  (org-confirm-babel-evaluate nil "Eval withour confirm")
  (org-display-inline-images t)
  (org-redisplay-inline-images t)
  (org-startup-with-inline-images "inlineimages")
  (org-startup-folded t)
  (org-directory "~/org")
  (org-agenda-files (list "agenda.org" "~/.org-jira"))
  (org-log-done 'time)
  ;; Remove tab useless source block identation
  (org-src-preserve-indentation nil)
  (org-edit-src-content-indentation 0)
  :config

  (defun dy-clear-image-cache ()
  "Clear cached images"
  (interactive)
  (clear-image-cache))

  (add-hook
   'org-mode-hook
   (lambda()
     (keymap-set evil-normal-state-local-map "<SPC> m f" 'dy-clear-image-cache)
  ))

  (org-babel-do-load-languages
   'org-babel-load-languages
   '(
     (python . t)
     (shell . t)
     (emacs-lisp . t)
     (plantuml . t)
     (sql . t)
     ))
  ; (use-package ob-translate
  ; :ensure t
  ; :config
  ; (org-babel-do-load-languages
  ;  'org-babel-load-languages
  ;  '((translate . t))))
  (setq org-clock-sound "~/.emacs.d/alarm.wav")
  (add-hook 'org-babel-after-execute-hook 'org-redisplay-inline-images)
  (setq org-capture-templates
         '(("t" "Tasks" entry (file+headline "~/org/agenda.org" "Tasks")
  	  "* TODO %?\nSCHEDULED: %(org-insert-time-stamp (org-read-date nil t \"+1d\"))\n" )
	   ("m" "Meetings" entry (file+headline "~/org/agenda.org" "Meetings")
  	  "* Meeting: %(org-insert-time-stamp (org-read-date nil t \"+1d\"))\n%?" )
	   ("c" "Captures" entry (file+headline "~/org/agenda.org" "Captures")
  	  "* Capture %?\n%(org-insert-time-stamp (org-read-date nil t \"+1d\"))\n%c" )
	   )
	 )
)

(use-package org-mime
  :ensure t
 )
 
(require 'org-tempo)
(add-to-list 'org-structure-template-alist '("sh" . "src shell"))
(add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
(add-to-list 'org-structure-template-alist '("py" . "src python"))
#+END_SRC

tody
* Yas
** Settings
#+BEGIN_SRC emacs-lisp :results output silent
  (use-package yasnippet
    :ensure t
    :custom
    (yas-snippet-dirs  '(
                         "~/.emacs.d/snippets"                 ;; personal snippets
                         )
                       "Set yasnippet dir")
    :config
    (yas-global-mode 1)
  )
#+END_SRC

* Rust
#+BEGIN_SRC emacs-lisp :results output silent
(use-package rust-mode
  :ensure t
  :custom
  (rust-format-on-save t "Format rust code on save")
  ;; (company-tooltip-align-annotations t "Company annotations")
  :mode ("\\rs\\'" . rust-mode)
  :config
  (add-hook 'rust-mode-hook #'lsp)
  ;; (keymap-set rust-mode-map "TAB" #'company-indent-or-complete-common)
)
#+END_SRC

** Rustic
#+BEGIN_SRC emacs-lisp :results output silent
(use-package rustic
  :ensure t
  :config
)
#+END_SRC

** Racer
#+BEGIN_SRC emacs-lisp :results output silent
;;  (use-package racer
;;    :ensure t
;;    :config
;;    (add-hook 'rust-mode-hook #'racer-mode)
;;    (add-hook 'racer-mode-hook #'eldoc-mode)
;;    (add-hook 'rust-mode-hook #'company-mode)
;;    (setq racer-rust-src-path "/home/dyens/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib")
;;  )
#+END_SRC

** Test at point
#+BEGIN_SRC emacs-lisp :results output silent
  (defun rust-test-buffer ()
    "Test buffer using `cargo test`"
    (interactive)
    (let* ((project-root (projectile-ensure-project (projectile-project-root)))
          (relative-file (file-relative-name buffer-file-name project-root))
          (splitted-path (split-string relative-file "/"))
          (module-path-with-rs (string-join (cdr splitted-path) "::"))
          (module-path (substring module-path-with-rs 0 (- (length module-path-with-rs) 3))))
      (compile (format "%s test %s" rust-cargo-bin module-path))
    )
  )

  ;; Yes, i know. Its bullshit. It return first fn (name).
  ;; But for testing in general cases its ok.
  (defun rust-fname-at-point ()
    "Test buffer using `cargo test`"
    (interactive)
    (save-excursion
      (re-search-backward
       "^[ \t]\\{0,4\\}\\(fn\\)[ \t]+\\([a-zA-Z0-9_]+\\)" nil t)
      (buffer-substring-no-properties (match-beginning 2) (match-end 2)))
    )

  (defun rust-test-at-point ()
    "Test buffer using `cargo test`"
    (interactive)
    (let* ((project-root (projectile-ensure-project (projectile-project-root)))
          (relative-file (file-relative-name buffer-file-name project-root))
          (splitted-path (split-string relative-file "/"))
          (module-path-with-rs (string-join (cdr splitted-path) "::"))
          (module-path (substring module-path-with-rs 0 (- (length module-path-with-rs) 3)))
          (fname (rust-fname-at-point))
          (test-module-name "tests"))
      (compile (format "%s test %s::%s::%s" rust-cargo-bin module-path test-module-name fname))
    )
  )
#+END_SRC

** Bidnings
#+BEGIN_SRC emacs-lisp :results output silent
(add-hook
 'rust-mode-hook
 (lambda()
   (keymap-set evil-normal-state-local-map "<SPC> m c" 'rust-run-clippy)
   (keymap-set evil-normal-state-local-map "<SPC> m C" 'rust-compile)
   (keymap-set evil-normal-state-local-map "<SPC> m r" 'rust-run)
   (keymap-set evil-normal-state-local-map "<SPC> T a" 'rust-test)
   (keymap-set evil-normal-state-local-map "g d" 'racer-find-definition)
   (keymap-set evil-normal-state-local-map "<SPC> T b" 'rust-test-buffer)
   (keymap-set evil-normal-state-local-map "<SPC> =" 'lsp-format-buffer)
   (keymap-set evil-normal-state-local-map "<SPC> t" 'rust-test-at-point)
   ))
#+END_SRC

* Abbrev
** Settings
#+BEGIN_SRC emacs-lisp :results output silent
(defun dy-setup-my-abbrev () 
  (clear-abbrev-table global-abbrev-table)

  (define-abbrev-table 'global-abbrev-table
    '(

      ;; net abbrev
      ("afaik" "as far as i know" )
      ))

  (when (boundp 'python-mode-abbrev-table)
    (clear-abbrev-table python-mode-abbrev-table))

  (define-abbrev-table 'rust-mode-abbrev-table
    '(
      ("print" "println!(\"{:?}\", var);")
      ))



  (define-abbrev-table 'python-mode-abbrev-table
    '(
      ("ass" "assert")
      ("fr" "from")
      ("imp" "import")
      ("tr" "import pdb; pdb.set_trace()")
      ))

  (define-abbrev-table 'c++-mode-abbrev-table
    '(
      ("cls" "class A {
Public:
    A();
Private:
    int var;
}")
      ))


  ;; (define-abbrev c++-mode-abbrev-table "if"
  ;;   "" 'cpp-skeleton-if)

  (define-abbrev c++-mode-abbrev-table "fn"
    "" 'cpp-skeleton-fn)

  (define-abbrev c++-mode-abbrev-table "getter"
    "" 'cpp-skeleton-get)

  (define-abbrev c++-mode-abbrev-table "setter"
    "" 'cpp-skeleton-set)

  ;;(define-abbrev c++-mode-abbrev-table "for"
  ;;  "" 'cpp-skeleton-for)

  (define-abbrev c++-mode-abbrev-table "print"
    "" 'cpp-skeleton-print)

  (define-abbrev c++-mode-abbrev-table "cls"
    "" 'cpp-skeleton-cls)

  (define-abbrev c++-mode-abbrev-table "ns"
    "" 'cpp-skeleton-ns)

  (define-abbrev c++-mode-abbrev-table "maint"
    "" 'cpp-skeleton-main-t)

  (setq skeleton-end-hook nil)
  ;; (clear-abbrev-table c++-mode-abbrev-table)

  (define-skeleton cpp-skeleton-if
    "cpp-skeleton-if" nil
    "if (" _ ")"\n
    -2"{"\n
    -2"}"\n
    )

  (define-skeleton cpp-skeleton-for
    "cpp-skeleton-for" nil
    "for (" _ ")"\n
    -2"{"\n
    -2"}"\n
    )

  (define-skeleton cpp-skeleton-fn
    "cpp-skeleton-fn" nil
    "void " _ "()"\n
    -1"{"\n
    -2"}"\n
    )

  (define-skeleton cpp-skeleton-get
    "cpp-skeleton-get" nil
    "[[nodiscard]] int get" _ "() const"\n
    -2"{"\n
    -2"}"\n
    )

  (define-skeleton cpp-skeleton-set
    "cpp-skeleton-set" nil
    "void set" _ "() "\n
    -2"{"\n
    -2"}"\n
    )

  (define-skeleton cpp-skeleton-print
    "cpp-skeleton-print" nil
    "std::cout << " _ " << std::endl;"\n
    )

  (define-skeleton cpp-skeleton-cls
    "cpp-skeleton-cls" nil
    "class " _  \n
    -1"{"\n
    -2"public:"\n
    -2"private:"\n
    -2"}"\n
    )

  (define-skeleton cpp-skeleton-ns
    "cpp-skeleton-ns" nil
    "namespace " _ "{"\n
    -2"}"\n
    )

  (define-skeleton cpp-skeleton-main-t
    "cpp-skeleton-main-t" nil
    "#include<iostream>" \n
    "#include<vector>" \n
    "#include<map>" \n
    "#include<memory>" \n
    \n
    "int main() {" \n
    > _ \n
    -2"}"\n
    )

  (set-default 'abbrev-mode t)

  (setq save-abbrevs nil)
  )

;;(dy-setup-my-abbrev )
#+END_SRC

* Tempel
#+BEGIN_SRC emacs-lisp :results output silent
(use-package tempel
:ensure t
:config
;; (global-tempel-abbrev-mode)
;; (set-default 'abbrev-mode t)
)
#+END_SRC
* Post Settings
* Plantuml
#+BEGIN_SRC emacs-lisp :results output silent
(use-package plantuml-mode
  :ensure t
  :defer t
  :mode ("\\plantuml\\'" . plantuml-mode)
  :custom
  (plantuml-jar-path "/home/dyens/.emacs.d/plantuml.jar")
  (org-plantuml-jar-path "/home/dyens/.emacs.d/plantuml.jar")
  )
#+END_SRC

* Org-jira
#+BEGIN_SRC emacs-lisp :results output silent
(use-package org-jira
  :ensure t
  :custom
  (jiralib-url "https://jira.croc.ru/")
  :config
  (setq jiralib-token
      (cons "Authorization"
          (concat "Bearer " (auth-source-pick-first-password
              :host "jira.croc.ru"))))
  )
#+END_SRC

* Expand-region
#+BEGIN_SRC emacs-lisp :results output silent
  (use-package expand-region
    :ensure t
    :config
    (keymap-set evil-normal-state-map "<SPC> e" 'er/expand-region)
    )
#+END_SRC
* Daemon
Need set in .zshrc 

alias em="emacsclient -c -a emacs"
#+BEGIN_SRC emacs-lisp :results output silent
  (server-start)
#+END_SRC

* Mail

#+BEGIN_SRC emacs-lisp :results output silent

  ;; First sudo dnf install maildir-utils
  ;; Setup mbrsync
  ;; Then init mu
  ;; mu init --maildir=~/mailbox --my-address=alexander.kapustin@quantumsoft.ru --my-address=akapustin@ambrahealth.com --my-address=dyens@mail.ru
  ;; mu index




  (defun dy-emails-set-all-as-read ()
    "Make all emails read."
    (interactive)
    (require 'mu4e-contrib)
    (with-temp-buffer
      (mu4e-headers-search-bookmark "flag:unread AND NOT flag:trashed")
      (sleep-for 0.15)
      (mu4e-headers-mark-all-unread-read)
      (mu4e-mark-execute-all 'no-confirmation)))

  (add-to-list 'load-path "/usr/share/emacs/site-lisp/mu4e")


  (defun enter-mu4e-context-mail ()
    (setq mu4e-drafts-folder   "/mail/drafts"
          mu4e-sent-folder "/mail/sent"
          ;; mu4e-refile-folder  "/mail/[Gmail]/All Mail"
          mu4e-trash-folder  "/mail/trash"
          mu4e-maildir-shortcuts
          '((:maildir "/mail/inbox" :key ?i)
            (:maildir "/mail/sent"  :key ?s)
            (:maildir "/mail/trash" :key ?t))))

  (defun enter-mu4e-context-ambra ()
    (setq mu4e-drafts-folder   "/ambra/[Gmail]/Drafts"
          mu4e-sent-folder "/ambra/[Gmail]/Sent Mail"
          ;; mu4e-refile-folder  "/ambra/[Gmail]/All Mail"
          mu4e-trash-folder  "/ambra/[Gmail]/Trash"
          mu4e-maildir-shortcuts
          '((:maildir "/ambra/inbox" :key ?i)
            (:maildir "/ambra/[Gmail]/Sent Mail" :key ?s)
            (:maildir "/ambra/[Gmail]/Trash" :key ?t))))

  (defun enter-mu4e-context-quantumsoft ()
    (setq mu4e-drafts-folder   "/quantumsoft/[Gmail]/Drafts"
          mu4e-sent-folder "/quantumsoft/[Gmail]/Sent Mail"
          ;; mu4e-refile-folder  "/quantumsoft/[Gmail]/All Mail"
          mu4e-trash-folder  "/quantumsoft/[Gmail]/Trash"
          mu4e-maildir-shortcuts
          '((:maildir "/quantumsoft/inbox" :key ?i)
            (:maildir "/quantumsoft/[Gmail]/Sent Mail" :key ?s)
            (:maildir "/quantumsoft/[Gmail]/Trash" :key ?t))))

  (setq dy-mu4e-bookmarks-mail
        '(("maildir:/mail/inbox" "Inbox" ?i)
          ("flag:unread AND to:dyens@mail.ru" "Unread messages" ?u)
          ("date:today..now AND to:dyens@mail.ru" "Today's messages" ?t)
          ("date:7d..now AND to:dyens@mail.ru" "Last 7 days" ?w)
          ("mime:image/* AND to:dyens@mail.ru" "Messages with images" ?p)))


  (setq dy-mu4e-bookmarks-ambra
        '(("maildir:/ambra/inbox" "Inbox" ?i)
          ("flag:unread AND to:akapustin@ambrahealth.com" "Unread messages" ?u)
          ("date:today..now AND to:akapustin@ambrahealth.com" "Today's messages" ?t)
          ("date:7d..now AND to:akapustin@ambrahealth.com" "Last 7 days" ?w)
          ("mime:image/* AND to:akapustin@ambrahealth.com" "Messages with images" ?p)))


  (setq dy-mu4e-bookmarks-quantumsoft
        '(("maildir:/quantumsoft/inbox" "Inbox" ?i)
          ("flag:unread AND to:akapustin@quantumsofthealth.ru" "Unread messages" ?u)
          ("date:today..now AND to:akapustin@quantumsofthealth.ru" "Today's messages" ?t)
          ("date:7d..now AND to:akapustin@quantumsofthealth.ru" "Last 7 days" ?w)
          ("mime:image/* AND to:akapustin@quantumsofthealth.ru" "Messages with images" ?p)))


  ;; (setq mu4e-alert-mu4e-header-func-var  "A")
  (use-package mu4e-alert
      :ensure t
      :config
      (mu4e-alert-set-default-style 'libnotify)
      (add-hook 'after-init-hook #'mu4e-alert-enable-notifications)
   )

  (use-package mu4e
    :ensure nil
    :config

    ;; This is set to 't' to avoid mail syncing issues when using mbsync
    (setq mu4e-change-filenames-when-moving t)

    ;; Refresh mail using isync every 10 minutes
    (setq mu4e-update-interval (* 10 60))
    (setq mu4e-get-mail-command "mbsync -a")
    (setq mu4e-maildir "~/mailbox")
    (setq mu4e-bookmarks dy-mu4e-bookmarks-mail)

    (setq message-send-mail-function 'smtpmail-send-it
          starttls-use-gnutls t
          smtpmail-starttls-credentials
          '(("smtp.gmail.com" 587 nil nil))
          smtpmail-auth-credentials
          (expand-file-name "~/.authinfo")
          smtpmail-default-smtp-server "smtp.gmail.com"
          smtpmail-smtp-server "smtp.gmail.com"
          smtpmail-smtp-service 587
          smtpmail-debug-info t)

    (setq mu4e-contexts
          `(
           ;; Mail personal
           ,(make-mu4e-context
            :name "Mail"
            :match-func
              (lambda (msg)
                (when msg
                  (string-prefix-p "/mail" (mu4e-message-field msg :maildir))))
            :vars `((user-mail-address . "dyens@mail.ru")
                    (smtpmail-starttls-credentials . '(("smtp.mail.com" 465 nil nil)))
                    (smtpmail-auth-credentials . (expand-file-name "~/.authinfo"))
                    (smtpmail-smtp-service . 465)
                      (smtpmail-smtp-user . "dyens@mail.ru")
                      (smtpmail-smtp-server . "smtp.mail.ru" )
                    (smtpmail-stream-type . ssl)
                    (mu4e-bookmarks . ,dy-mu4e-bookmarks-mail)
                    (user-full-name . "Kapustin Alexander"))
            :enter-func (lambda () (progn
                                (mu4e-message "Entering Mail Context")
                                (enter-mu4e-context-mail)))
            :leave-func (lambda () (mu4e-message "Leave Mail Context")))

           ;; Ambra work account
           ;; ,(make-mu4e-context
           ;;  :name "Ambra"
           ;;  :match-func
           ;;    (lambda (msg)
           ;;      (when msg
           ;;        (string-prefix-p "/ambra" (mu4e-message-field msg :maildir))))
           ;;  :vars `((user-mail-address . "akapustin@ambrahealth.com")
           ;;            (smtpmail-smtp-user . "akapustin@ambrahealth.com")
           ;;            (smtpmail-smtp-server . "smtp.gmail.com" )
           ;;          (mu4e-bookmarks . ,dy-mu4e-bookmarks-ambra)
           ;;          (user-full-name    . "Kapustin Alexander"))
           ;;  :enter-func (lambda () (progn
           ;;                      (mu4e-message "Entering Ambra Context")
           ;;                      (enter-mu4e-context-ambra)))
           ;;  :leave-func (lambda () (mu4e-message "Leave Ambra Context")))

           ;; Quantumsoft work account
           ,(make-mu4e-context
            :name "Quantumsoft"
            :match-func
              (lambda (msg)
                (when msg
                  (string-prefix-p "/quantumsoft" (mu4e-message-field msg :maildir))))
            :vars `((user-mail-address . "alexander.kapustin@quantumsoft.ru")
                      (smtpmail-smtp-user . "alexander.kapustin@quantumsoft.ru")
                      (smtpmail-smtp-server . "smtp.gmail.com" )
                    (mu4e-bookmarks . ,dy-mu4e-bookmarks-quantumsoft)
                    (user-full-name    . "Kapustin Alexander"))
            :enter-func (lambda () (progn
                                (mu4e-message "Entering Quantumsoft Context")
                                (enter-mu4e-context-quantumsoft)))
            :leave-func (lambda () (mu4e-message "Leave Quantumsoft Context"))))))
#+END_SRC




#TODO https://github.com/emacs-evil/evil-collection
* Aspell
#+BEGIN_SRC emacs-lisp :results output silent
  (setq ispell-program-name "aspell")
#+END_SRC

* Dy surround
#+BEGIN_SRC emacs-lisp :results output silent
  ;; From https://protesilaos.com/codelog/2020-08-03-emacs-custom-functions-galore/
  (defconst dy-insert-pair-alist
    '(("' Single quote" . (39 39))           ; ' '
      ("\" Double quotes" . (34 34))         ; " "
      ("` Elisp quote" . (96 39))            ; ` '
      ("‘ Single apostrophe" . (8216 8217))  ; ‘ ’
      ("“ Double apostrophes" . (8220 8221)) ; “ ”
      ("( Parentheses" . (40 41))            ; ( )
      ("{ Curly brackets" . (123 125))       ; { }
      ("[ Square brackets" . (91 93))        ; [ ]
      ("< Angled brackets" . (60 62))        ; < >
      ("« tree brakets" . (171 187)))        ; « »
    "Alist of pairs for use with.")

  ;; From https://protesilaos.com/codelog/2020-08-03-emacs-custom-functions-galore/
  (defun dy-insert-pair-completion (&optional arg)
    "Insert pair from."
    (interactive "P")
    (let* ((data dy-insert-pair-alist)
           (chars (mapcar #'car data))
           (choice (completing-read "Select character: " chars nil t))
           (left (cadr (assoc choice data)))
           (right (caddr (assoc choice data))))
      (insert-pair arg left right)))

  (keymap-set evil-visual-state-map "<SPC> q" 'dy-insert-pair-completion)
#+END_SRC
* Dy capitalize first char
#+BEGIN_SRC emacs-lisp :results output silent
(defun dy-capitalize-first-char (&optional string)
  "Capitalize only the first character of the input STRING."
  (when (and string (> (length string) 0))
    (let ((first-char (substring string nil 1))
          (rest-str   (substring string 1)))
      (concat (capitalize first-char) rest-str))))
#+END_SRC
* Google-translate
#+BEGIN_SRC emacs-lisp :results output silent
(use-package popup
    :ensure t
 )
(use-package google-translate
    :ensure t
    :custom
    (google-translate-backend-method 'curl)
    :config
    ;; https://github.com/atykhonov/google-translate/issues/52#issuecomment-727920888
    (defun google-translate--search-tkk () "Search TKK." (list 430675 2721866130))
    (keymap-set evil-normal-state-map "<SPC> r r" 'dy-google-translate)
    (keymap-set evil-normal-state-map "<SPC> r R" 'dy-google-translate-reverse)

    (keymap-set evil-visual-state-map "<SPC> r r" 'dy-google-translate)
    (keymap-set evil-visual-state-map "<SPC> r R" 'dy-google-translate-reverse)

    (keymap-set evil-normal-state-map "<SPC> r q" 'google-translate-query-translate)
    (keymap-set evil-normal-state-map "<SPC> r Q" 'google-translate-query-translate-reverse)
    (setq google-translate-default-source-language "en")
    (setq google-translate-default-target-language "ru"))
#+END_SRC
* Smerge
** Bidnings
#+BEGIN_SRC emacs-lisp :results output silent
  (add-hook
   'smerge-mode-hook
   (lambda()
     (keymap-set evil-normal-state-local-map "<SPC> j" 'smerge-next)
     (keymap-set evil-normal-state-local-map "<SPC> k" 'smerge-prev)
     (keymap-set evil-normal-state-local-map "<SPC> <SPC>" 'smerge-keep-current)
     (keymap-set evil-normal-state-local-map "<SPC> h" 'smerge-keep-other)
     (keymap-set evil-normal-state-local-map "<SPC> l" 'smerge-keep-mine)
     ))
#+END_SRC

* Lilypond
#+BEGIN_SRC emacs-lisp :results output silent
(setq load-path (append (list (expand-file-name "lilypond" init-dir)) load-path))
(autoload 'LilyPond-mode "lilypond-mode" "LilyPond Editing Mode" t)
(add-to-list 'auto-mode-alist '("\\.ly$" . LilyPond-mode))
(add-to-list 'auto-mode-alist '("\\.ily$" . LilyPond-mode))
(add-hook 'LilyPond-mode-hook (lambda () (turn-on-font-lock)))
#+END_SRC

* SLY
#+BEGIN_SRC emacs-lisp :results output silent
(use-package sly
  :ensure t)
#+END_SRC

* Tree sitter
#+BEGIN_SRC emacs-lisp :results output silent
(use-package tree-sitter
  :ensure t
  :config
  (global-tree-sitter-mode)
  (add-hook 'tree-sitter-after-on-hook #'tree-sitter-hl-mode)
)
(use-package tree-sitter-langs
  :ensure t)
#+END_SRC

* Multiple Cursors
#+BEGIN_SRC emacs-lisp :results output silent
(use-package evil-multiedit
  :ensure t
  :config
  (require 'evil-multiedit)
  ;; Highlights all matches of the selection in the buffer.
  (keymap-set evil-visual-state-map "R" 'evil-multiedit-match-all)
  
  ;; Match the word under cursor (i.e. make it an edit region). Consecutive presses will
  ;; incrementally add the next unmatched match.
  (keymap-set evil-normal-state-map "M-d" 'evil-multiedit-match-and-next)
  ;; Match selected region.
  (keymap-set evil-visual-state-map "M-d" 'evil-multiedit-match-and-next)
  ;; Insert marker at point
  (keymap-set evil-insert-state-map "M-d" 'evil-multiedit-toggle-marker-here)
   ;; Ex command that allows you to invoke evil-multiedit with a regular expression, e.g.
  (evil-ex-define-cmd "ie[dit]" 'evil-multiedit-ex-match))

#+END_SRC

* Widnow monocle
https://protesilaos.com/codelog/2020-08-03-emacs-custom-functions-galore/
#+BEGIN_SRC emacs-lisp :results output silent
(use-package emacs
  :config
  (defvar dy-window-configuration nil
    "Current window configuration.
Intended for use by `dy-window-monocle'.")

  (define-minor-mode dy-window-single-toggle
    "Toggle between multiple windows and single window.
This is the equivalent of maximising a window.  Tiling window
managers such as DWM, BSPWM refer to this state as 'monocle'."
    :lighter " [M]"
    :global nil
    (if (one-window-p)
        (when dy-window-configuration
          (set-window-configuration dy-window-configuration))
      (setq dy-window-configuration (current-window-configuration))
      (delete-other-windows)))

  (keymap-set evil-normal-state-map "<SPC> z" 'dy-window-single-toggle)
)

#+END_SRC

* Zoom
#+BEGIN_SRC emacs-lisp :results output silent
;; (use-package zoom
;;   :ensure t
;;   :custom
;;   (zoom-mode t)
;;   :config
;;   (defun dy-size-callback ()
;;     (cond ((> (frame-pixel-width) 1280) '(90 . 0.75))
;;           (t                            '(0.5 . 0.5))))
;;   (setq zoom-size 'dy-size-callback))
#+END_SRC
* Lua
#+BEGIN_SRC emacs-lisp :results output silent
(use-package lua-mode
  :ensure t)
#+END_SRC

* Org Roam
#+BEGIN_SRC emacs-lisp :results output silent

(use-package org-roam
  :ensure t
  :init
  (setq org-roam-v2-ack t)
  :custom
  (org-roam-directory "~/org_roam")
  (org-roam-completion-everywhere t)
  :bind (("C-c n l" . org-roam-buffer-toggle)
         ("C-c n f" . org-roam-node-find)
         ("C-c n i" . org-roam-node-insert)
         :map org-mode-map
         ("C-M-i"    . completion-at-point))
  :config
  (org-roam-setup))
#+END_SRC

* Compilation mode
** Truncate compilation buffer
If in compilation buffer there are many lines it start to be a very slow
#+BEGIN_SRC emacs-lisp :results output silent
(add-hook 'compilation-filter-hook 'comint-truncate-buffer)
(setq comint-buffer-maximum-size 2000)
#+END_SRC

** Scroll to the first error
#+BEGIN_SRC emacs-lisp :results output silent
(setq compilation-scroll-output 'first-error)
#+END_SRC

** COMMENT Notifications
#+BEGIN_SRC emacs-lisp :results output silent
(defcustom dy-notify-after-compilation nil "Notifcation after compilation" :type 'hook :options '(t nil) :group 'dy-settings)
;; (custom-set-variables '(dy-notify-after-compilation t))

(setq compilation-finish-functions
      (append compilation-finish-functions
          '(dy-local-notify-compilation-finish)))

(defcustom dy-compilation-notify nil
  "Non-nil means automatically frobnicate all buffers."
  :type 'boolean
  :require 'compilation-mode
  :group 'dy-custom)

(defun dy-local-notify-compilation-finish (buffer status)
  "Notify compilation finish."
  (if dy-notify-after-compilation
      (dy-notify "Compilation finished in Emacs" status)))
#+END_SRC

* Dired
#+BEGIN_SRC emacs-lisp :results output silent
(use-package dired
  :ensure nil
  :commands (dired dired-jump)
  :bind (("C-x C-j" . dired-jump))
  :custom (
    (dired-listing-switches "-agho --group-directories-first")
    (dired-dwim-target t)
  )
  :config
  (evil-collection-define-key 'normal 'dired-mode-map
    "h" 'dired-single-up-directory
    "l" 'dired-single-buffer))

(use-package dired-single
  :ensure t)

(use-package dired-open
  :ensure t
  :config
  ;; Doesn't work as expected!
  ;(add-to-list 'dired-open-functions #'dired-open-xdg t)
  (setq dired-open-extensions '(("png" . "feh")
                                ("mp4" . "mplayer"))))

#+END_SRC
* Eshell
#+BEGIN_SRC emacs-lisp :results output silent
;; From SystemCrafters
;; https://github.com/daviwil/emacs-from-scratch/blob/bbfbc77b3afab0c14149e07d0ab08d275d4ba575/Emacs.org#terminals
(defun dy-configure-eshell ()
  ;; Save command history when commands are entered
  (add-hook 'eshell-pre-command-hook 'eshell-save-some-history)

  ;; Truncate buffer for performance
  (add-to-list 'eshell-output-filter-functions 'eshell-truncate-buffer)

  ;; Bind some useful keys for evil-mode
  (evil-define-key '(normal insert visual) eshell-mode-map (kbd "C-r") 'counsel-esh-history)
  (evil-define-key '(normal insert visual) eshell-mode-map (kbd "<home>") 'eshell-bol)
  (evil-normalize-keymaps)

  (setq eshell-history-size         10000
        eshell-buffer-maximum-lines 10000
        eshell-hist-ignoredups t
        eshell-scroll-to-bottom-on-input t))

(use-package eshell-git-prompt
 :ensure t
)

(use-package eshell
  :hook (eshell-first-time-mode . dy-configure-eshell)
  :config

  (with-eval-after-load 'esh-opt
    (setq eshell-destroy-buffer-when-process-dies t)
    (setq eshell-visual-commands '("htop" "zsh" "vi")))

  (eshell-git-prompt-use-theme 'powerline)
)
#+END_SRC

* Vterm
#+BEGIN_SRC emacs-lisp :results output silent
(use-package vterm
  :ensure t
  :custom
  (vterm-shell "zsh")
)
#+END_SRC
* Multi-Vterm
#+BEGIN_SRC emacs-lisp :results output silent
(use-package multi-vterm
  :after vterm
  :ensure t)
#+END_SRC

* Shell
#+BEGIN_SRC emacs-lisp :results output silent
(setq shell-file-name "zsh")
#+END_SRC

* C++
** Clang-Format
#+BEGIN_SRC emacs-lisp :results output silent
;; clang-format --style=google --dump-config > .clang-format 
(use-package clang-format
  :ensure t
)
#+END_SRC

** Bidnings
#+BEGIN_SRC emacs-lisp :results output silent
(add-hook
 'c++-mode-hook
 (lambda()
   (keymap-set evil-normal-state-map "<SPC> =" 'clang-format-buffer)
   (keymap-set evil-normal-state-map "<SPC> m d" 'dy-dox-fn)
   ))
#+END_SRC

** Ggtags
#+BEGIN_SRC emacs-lisp :results output silent

(use-package ggtags
  :ensure t
  :config
;; With lsp is good to use default evil go to definition
;; 
;;    (add-hook 'c-mode-common-hook
;;            (lambda ()
;;                (when (derived-mode-p 'c-mode 'c++-mode 'java-mode 'asm-mode)
;;                (ggtags-mode 1))))
  )

;; (keymap-set ggtags-mode-map "C-c g s" 'ggtags-find-other-symbol)
;; (keymap-set ggtags-mode-map "C-c g h" 'ggtags-view-tag-history)
;; (keymap-set ggtags-mode-map "C-c g r" 'ggtags-find-reference)
;; (keymap-set ggtags-mode-map "C-c g f" 'ggtags-find-file)
;; (keymap-set ggtags-mode-map "C-c g c" 'ggtags-create-tags)
;; (keymap-set ggtags-mode-map "C-c g u" 'ggtags-update-tags)
;; 
;; (keymap-set ggtags-mode-map "M-," 'pop-tag-mark)
#+END_SRC
** Cmake
#+BEGIN_SRC emacs-lisp :results output silent
(use-package cmake-mode
  :ensure t
  )
#+END_SRC

* RG
#+BEGIN_SRC emacs-lisp :results output silent
(use-package rg
  :ensure t)
#+END_SRC
* Telega
#+BEGIN_SRC emacs-lisp :results output silent
(use-package telega
  :ensure t)
#+END_SRC

* Ace window
#+BEGIN_SRC emacs-lisp :results output silent
(use-package ace-window
  :ensure t)
#+END_SRC

* Dap mode
#+BEGIN_SRC emacs-lisp :results output silent
(use-package dap-mode
  :ensure t
  :config
    )
#+END_SRC

* Lispy
#+BEGIN_SRC emacs-lisp :results output silent
;; (use-package lispy
;;   :ensure t
;;   :config
;;     )
;; 
;; (use-package evil-lispy
;;   :ensure t
;;   :config
;;     )
#+END_SRC
* Nov (epub reading)
#+BEGIN_SRC emacs-lisp :results output silent
(use-package nov
  :ensure t
  :config
   (add-to-list 'auto-mode-alist '("\\.epub\\'" . nov-mode))
    )
#+END_SRC
* PDF
#+BEGIN_SRC emacs-lisp :results output silent
(use-package pdf-tools
  :ensure t
  :config
  (pdf-tools-install))
#+END_SRC

* Paredit
#+BEGIN_SRC emacs-lisp :results output silent
(use-package paredit
  :ensure t
  :config
  (add-hook 'emacs-lisp-mode-hook #'paredit-mode)
  ;; enable in the *scratch* buffer
  (add-hook 'lisp-interaction-mode-hook #'paredit-mode)
  (add-hook 'ielm-mode-hook #'paredit-mode)
  (add-hook 'lisp-mode-hook #'paredit-mode)
  (add-hook 'eval-expression-minibuffer-setup-hook #'paredit-mode)
  ;; (add-hook 'c++-mode-hook #'paredit-mode)
  ;; (add-hook 'c-mode-hook #'paredit-mode)
  ;; (add-hook 'python-mode-hook #'paredit-mode)
    )
#+END_SRC
* Vue
#+BEGIN_SRC emacs-lisp :results output silent
(use-package vue-mode
  :ensure t
  :config
  (setq js-indent-level 2)
  (setq css-indent-offset 2)
)
#+END_SRC
* Run command
#+BEGIN_SRC emacs-lisp :results output silent
(use-package run-command
  :ensure t
)

(defun run-command-recipe-example ()
  (list
   ;; Run a simple command
   (list :command-name "say-hello"
         :command-line "echo Hello, World!")))
(setq run-command-recipes '(run-command-recipe-example))
#+END_SRC
* Kubernetes
#+BEGIN_SRC emacs-lisp :results output silent
(use-package kubernetes
  :ensure t
)

(use-package kubernetes-evil
  :ensure t
  :after kubernetes)
#+END_SRC
* Terraform
#+BEGIN_SRC emacs-lisp :results output silent
(use-package terraform-mode
  :ensure t
)
#+END_SRC

* Dy
#+BEGIN_SRC emacs-lisp :results output silent

(defun dy-reload-dir-locals-for-current-buffer ()
  "reload dir locals for the current buffer"
  (interactive)
  (let ((enable-local-variables :all))
    (hack-dir-local-variables-non-file-buffer)))

(defun dy-reload-dir-locals-for-all-buffer-in-this-directory ()
  "For every buffer with the same `default-directory` as the 
current buffer's, reload dir-locals."
  (interactive)
  (let ((dir default-directory))
    (dolist (buffer (buffer-list))
      (with-current-buffer buffer
        (when (equal default-directory dir)
          (dy-reload-dir-locals-for-current-buffer))))))

(defun dy-erc ()
  "Run erc. Default erc does not work."
  (interactive)
   (erc :server "irc.libera.chat" :full-name "Alexander Kapustin" :user "dyens")
 )

(defun dy-notify (text &optional body)
  "Desktop notify.

  After next building emacs (build with bus) use:
      (notifications-notify :text \"test\")
  "
  (interactive)
  (unless body (setq body ""))
  (call-process "notify-send" nil nil nil
		"-t" "0"
		"-i" "emacs"
		text
		body))

(defun dy-screaming-to-camel (s)
  "Convert screaming to camel case.
  Example:
      HELLO_WORLD -> HelloWorld
  " 
  (mapconcat 'capitalize (split-string s "_") ""))

(defun dy-set-fast-function (fn_name)
  "Set some function on <SPC> ` in evil normal state map."
  (interactive "aBind function name: ")
  (keymap-set evil-normal-state-map "<SPC> `" fn_name)
  )

;; https://protesilaos.com/codelog/2021-07-24-emacs-misc-custom-commands/
;; A variant of this is present in the crux.el package by Bozhidar
;; Batsov.
(defun dy-rename-file-and-buffer (name)
  "Apply NAME to current file and rename its buffer.
Do not try to make a new directory or anything fancy."
  (interactive
   (list (read-string "Rename current file: " (buffer-file-name))))
  (let ((file (buffer-file-name)))
    (if (vc-registered file)
        (vc-rename-file file name)
      (rename-file file name))
    (set-visited-file-name name t t)))


(defun dy-google-translate ()
  (interactive)
  (let* ((langs (google-translate-read-args nil nil))
         (source-language (car langs))
         (target-language (cadr langs))
	 (p1 (region-beginning))
	 (p2 (region-end)))
    (if (use-region-p)
	(google-translate-translate
	 source-language target-language
	 (buffer-substring-no-properties p1 p2))
      (google-translate-at-point))))


(defun dy-google-translate-reverse ()
  (interactive)
  (let* ((langs (google-translate-read-args nil nil))
         (source-language (cadr langs))
         (target-language (car langs))
	 (p1 (region-beginning))
	 (p2 (region-end)))
    (if (use-region-p)
	(google-translate-translate
	 source-language target-language
	 (buffer-substring-no-properties p1 p2))
      (google-translate-at-point-reverse))))



(defun dy-hud-choose-compile-command (command)
  "Compilation hud project and libs."
  (interactive
   (list
    (completing-read "Compilation command: "
		     '(
		       "cd catkin_ws && catkin_make run_tests --use-ninja"
		       "cd catkin_ws && catkin_make run_tests_hud_data_gtest_utils_camera_object_bbox  --use-ninja"
		       "cd catkin_ws && catkin_make bag_analyze  -DFORCE_BUILD_ANALYZER:BOOL=true"
		       "make"
		       "make clean"
		       ))))
  (projectile--run-project-cmd command projectile-compilation-cmd-map
			       :show-prompt t
			       :prompt-prefix "Compile command: "
			       :save-buffers t
			       :use-comint-mode projectile-compile-use-comint-mode))


(defun dy-hud-cppcheck ()
  "Start cpp check for hud."
  (interactive)
  (projectile-with-default-dir (projectile-acquire-root)
    (async-shell-command
     "cd catkin_ws && cppcheck -q --enable=all --std=c++17  --inconclusive --project=src/compile_commands.json  --suppress=\"*:/home/dyens/ros_catkin_ws/*\" --suppress=\"*:devel/include/helm_msgs/*\" --suppress=\"unusedFunction:*\" -i build"
     "*hud-cppcheck*")))


(defun dy-hud-tidy ()
  "Start tidy for hud."
  (interactive)
  (let ((compilation-buffer-name-function (lambda (x) "*tidy checks*"))
	(default-directory (projectile-acquire-root)))
    (compile
     ;; funny command
     ;; Note: run-clang-tidy does not work - it use all files in project (include moc files)
     "cd catkin_ws && find src -type d \\( -path src/.ccls-cache -o -path src/hud_data/include/hud_data/msgs -o -path src/hud_data/src/msgs \\) -prune -o \\( -name '*.cpp' -o -name '*.h' \\) -print \
       | xargs -n1 -P9 clang-tidy")))


(defun dy-hud-clazy ()
  "Start clazy for hud."
  (interactive)
  (projectile-with-default-dir (projectile-acquire-root)
    (async-shell-command
     "cd catkin_ws && find src -type d -name .ccls-cache -prune -o -name '*.cpp' -o -name '*.h' -print | xargs /home/dyens/Qt/Tools/QtCreator/libexec/qtcreator/clang/bin/clazy-standalone"
     "*hud-clazy*")))


(defun dy-include-cpp-header ()
  "Include cpp header."
  (interactive)
  (save-excursion
    (let ((bname (replace-regexp-in-string "[.]" "_" (string-inflection-upcase-function (buffer-name)))))
      (goto-char (point-min))
      (insert (format "#ifndef %s\n#define %s\n\n" bname bname))
      (goto-char (point-max))
      (insert (format "\n#endif //%s" bname)))))


(defun dy-hud-tidy-check-one ()
  "Tidy check one file."
  (interactive)


  (projectile-with-default-dir (projectile-acquire-root)
    (async-shell-command
     (format "cd catkin_ws && clang-tidy %s" (buffer-file-name))
     "*hud-tidy-one-file*")))

;; cd catkin_ws && catkin_make install  -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=1 
;; cd catkin_ws && clang-tidy $(find src/hud_data/ -name "*.cpp" -not -path "*/msgs/*")  $(find src/hud_data/ -name "*.h" -not -path "*/msgs/*") $(find src/ros_data/ -name "*.cpp" -not -path "*/msgs/*")  $(find src/ros_data/ -name "*.h" -not -path "*/msgs/*")


(defun dy-dox-fn ()
  "Create doxygen docstring.

Cursor should be pointed on start fn eclaration."
  (interactive)
  (save-excursion
    (save-restriction
      (let ((pstart (point))
	    (pend)
	    (rtype)
	    (fname)
	    (fargs)
	    (docstring)
	    )
	(search-forward ";")
	(setq pend (point))
	(narrow-to-region pstart pend)
	(goto-char 0)
	(re-search-forward "[ \t]*\\(.+\\)[ \t]+\\(.+\\)[ \t]*\(\\(.*\\)\)")
	(setq rtype (buffer-substring-no-properties (match-beginning 1) (match-end 1)))
	(setq fname (buffer-substring-no-properties (match-beginning 2) (match-end 2)))
	(setq fargs (dy-parse-cpp-args (buffer-substring-no-properties (match-beginning 3) (match-end 3))))
	(setq docstring (concat
			 "/**\n"
			 "  * \\brief\n"
			 "  * %s\n"
			 "  * \\details\n"
			 "  * %s\n"
			 "  *\/\n"
			 ))

	
	(goto-char 0)
	(insert (format docstring fname fname))))))

(defun dy-parse-cpp-args (args-string)
  "Cpp args parser"
  (let ((f (lambda (el)
	     (string-trim
	      (car (last (split-string el " ")))
	      "[ \t\n\r&*]+"
	      "[ \t\n\r]+"))))
    (mapcar
     f
     (split-string args-string ","))))

(defun dy-get-git-origin-url ()
  "Return current git origin url"
  (let ((url (magit-git-output "config" "--get" "remote.origin.url")))
    (cond
     ((string-match "git@\\(.*\\):\\(.*\\)\.git" url) (format "https://%s/%s" (match-string 1 url) (match-string 2 url)))
     ((string-match "\\(.*\\)\.git" url) (match-string 1 url) )
     (t (error "Can not detect origin"))
     )))


(defun dy-open-in-github (github-url  &optional mode)
  "Open source file in github."
  (interactive)
  (let (
	(github-url (if (null github-url) (dy-get-git-origin-url) (github-url)))
	(github-path
	 (cond
	  ((eq mode nil) (magit-get-current-branch))
	  ((eq mode 'dev) "dev")
	  ((eq mode 'branch) (magit-get-current-branch))
	  ((eq mode 'rev) (magit-rev-abbrev "HEAD"))))

	(project-file (magit-file-relative-name ( buffer-file-name)) )
	(highlight
	 (if (use-region-p)
             (let ((l1 (line-number-at-pos (region-beginning)))
                   (l2 (line-number-at-pos (- (region-end) 1))))
               (format "#L%d-L%d" l1 l2))
           ""))
	(url))
    (setq url (format "%s/blob/%s/%s%s" github-url github-path project-file highlight))
    (shell-command (concat "firefox " url))))

(defun dy-open-in-github-branch()
    (interactive)
    (dy-open-in-github nil 'branch))

(defun dy-open-in-github-rev()
    (interactive)
    (dy-open-in-github nil 'rev))
#+END_SRC
